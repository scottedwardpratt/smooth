\documentclass[main.tex]{subfiles}
\begin{document}
\newpage
\setcounter{section}{5}
\section{Tuning the Emulator}

\subsection{Summary}

Smooth emulator finds a sample set of Taylor expansion coefficients that reproduce a set of observables at a set of training points. For a given observables, a particular sample set of coefficients gives the following emulated function:
\begin{align*}\eqnumber
E(\vec{\theta})&=\sum_{\vec{n}, s.t. \sum_in_i\le {\rm MaxRank}}\frac{d(\vec{n})}{(n_1+n_2+\cdots)!}
A_{\vec{n}}
\left(\frac{\theta_1}{\Lambda}\right)^{n_1}
\left(\frac{\theta_2}{\Lambda}\right)^{n_2}
\cdots.
\end{align*}
Here, $\theta_1\theta_2\cdots$ are the model parameters, scaled so that their priors range from -1 to +1, or if they are Gaussian, have unit variance. The degeneracy factor, $d(\vec{n})$ is the number of different ways to sum the powers $n_i$ to a given rank,
\begin{align*}\eqnumber
d(\vec{n})=\frac{n_1!n_2!\cdots}{(n_1+n_2+\cdots)!}.
\end{align*}

The emulator finds a predetermined number of sets of coefficients, where each set of coefficients provides a function that reproduces the real model at the training points. The User sets the number of sets of coefficients, typically of order $N_{\rm sample}\approx 10$, in a parameter file. Away from the training points, the uncertainty of the emulator is represented by the spread of the values amongst the $N_{\rm sample}$ predictions.

Smooth Emulator solves for the coefficients from the training data, then stores those coefficients in files for later use. Smooth Emulator can emulate either the full-model observables directly, or their principal components. Training the emulator follows the same steps for either approach. 

Before training the emulator, one must first run the full model at a given set of training points. In addition to a parameter file, which sets numerous options, the User must provide the following:
\begin{enumerate}\itemsep=0pt
    \item A file listing the names of observables, their uncertainties, and an estimate of the variance of each observable throughout the model-parameter space. This file will typically be {\tt Info/obs.txt}, where the path is relative to the project directory. 
    \item If the number of full-model runs performed is $N_{\rm train}$, Smooth emulator requires files for each run. Each file, typically {\tt modelruns/runI/mod\_parameters.txt} where $I$ varies from $1-N_{\rm train}$, describes the point in  parameter space for the $I^{\rm th}$ full-model run. 
    \item In the same directory, Smooth Emulator requires the observables calculated at the training points mentioned above. This information is provided in {\tt modelruns/runI/obs.txt}. 
\end{enumerate}
The parameter file, typically stored in {\tt parameters/emulator\_parameters.txt}, enables the User to select numerous option. For example, the User might use training data from a different directory, not {\tt modelruns/}, or might choose to use principal components rather than the observables directly. 

In the following subsections, we first review the format for each of the required input files, then describe how to run Smooth Emulator, how its output is stored, and how to switch PCA observables for the real observables.

\subsection{Smooth Emulator Parameters (not model parameters!)}

Smooth Emulator requires a parameter file. This can be located anywhere, as it will be specified on the command line when running Smooth Emulator, but is typically {\tt parameters/emulator\_parameters.txt}. The parameter file is simply a list, of parameter names followed by values. 

{\tt
\begin{verbatim}
 SmoothEmulator_NPars 4
 SmoothEmulator_LAMBDA 3.0
 SmoothEmulator_MAXRANK 4
 SmoothEmulator_NMC 100000  # Steps between samples 
 SmoothEmulator_NASample 8  # No. of coefficient samples
 SmoothEmulator_TuneChooseMCMC true # set false if NPars<5
 SmoothEmulator_UseSigmaYRreal false # 
 SmoothEmulator_ConstrainA0 true
 SmoothEmulator_CutoffA false
 SmoothEmulator_ModelRunDirName modelruns
 SmoothEmulator_CoefficientsDirName coefficients
 SmoothEmulator_ModelParInfoFileName
 SmoothEmulator_ObservableInfoFileName
\end{verbatim}
}
If any of these parameters are missing from the parameters file, Smooth Emulator will assign a default value.

\begin{enumerate}\itemsep 0pt
\item {\bf SmoothEmulator\_LAMBDA}\\
This is the smoothness parameter $\Lambda$. It sets the relative importance of terms of various rank. If $\Lambda$ is unity or less, it suggests that the Taylor expansion converges slowly. The default is 3.

\item {\bf SmoothEmulator\_MAXRANK}\\
As Smooth Emulator assumes a Taylor expansion, this the maximum power of $\theta^n$ that is considered. Higher values require more coefficients, which in turn, slows down the tuning process. The default is 4.
\item {\bf SmoothEmulator\_SmoothEmulator\_TuneChooseMCMC}\\
If set to {\tt false}, Smooth Emulator will set all but $N_{\rm train}$ coefficients randomly, according to their Gaussian prior. Then, it will solve for the remaining coefficients in order to fit the training data. The weight is calculated for the remaining coefficients, at which point the coefficients are kept or rejected proportional to the weight. The coefficients chosen in this manner are perfectly independent of one another, but at the cost of requiring many samplings before finding a weight to keep. This choice is efficient when the number of training points is small. If {\tt SmoothEmulator\_SmoothEmulator\_TuneChooseMCMC} is set to {\tt true}, Smooth Emulator will choose the coefficients as a small random step from the previous coefficients, then keep or reject the coefficients according to a Metropolis algorithm. The downside is that many steps are required to create a sampling set of coefficients that are independent of one another. This method is preferable for larger numbers of training points.  The default is {\tt true}.
\item {\bf SmoothEmulator\_NMC}\\
When the previous parameter is set to {\tt true}, this sets the number of steps between retained samples of coefficients. For larger numbers of parameters, this should be set at many thousands. Higher values lead to more independent sets of coefficients, but the calculation then requires more time. 
\item {\bf SmoothEmulator\_NASample}\\
Smooth Emulator finds $N_{\rm sample}$ sets of coefficients. Each set reproduces the training points, but differs away from the training points. Setting $N_{\rm sample}\sim 10$ should reasonably represent the uncertainty of the emulator. The default is set at 8.
\item {\bf SmoothEmulator\_UseSigmaYRreal}\\
If the real model has noise, the emulator should not be constrained to exactly reproduce the observables at the training points. In fact, if two training points are located close to one another in parameter space, Smooth Emulator might be force to find a particularly uneven function so that the points are exactly reproduced. If the User wishes to exactly reproduce the training points, this should be set to {\tt false}, as is the  default. 
\item {\bf SmoothEmulator\_ConstrainA0}\\
The coefficients in the Taylor expansion are assumed to have some weight,
\[
W(A_i)=\frac{1}{\sqrt{2\pi\sigma_A^2}}e^{-A_i^2/2\sigma_A^2}.
\]
The term $\sigma_A$ is allowed to vary during the tuning to maximize the likelihood of the expansion. If the User wishes to exempt the lowest term, i.e. the constant term in the Taylor expansion from the weight, the User may set {\tt SmoothEmulator\_ConstrainA0} to {\tt false}. The default is {\tt false}.
\item {\bf SmoothEmulator\_CutoffA}\\
This applies an additional multiplicative weight to the weight for $A$ above.
\[
W(A_i)_{\rm additional}=\frac{1}{1+\frac{1}{4}\frac{A_i^2}{\sigma_{A}^2}}.
\] 
Here $\sigma_{A0}$ is the initial guess for the spread. This can safeguard against the width $\sigma_A$ drifting off to arbitrarily large values. Unless necessary, it is recommended to leave this at the default, {\tt false}.
\item {\bf SmoothEmulator\_ModelRunDirName}\\
This gives the directory in which the training data from the full model runs is stored. The default is {\tt modelruns}.
\item {\bf SmoothEmulator\_CoefficientsDirName}\\
After tuning, Smooth Emulator can write the coefficients of the expansion to a file in this directory. Smooth Emulator can also read the coefficients. The default is {\tt coefficients}.
\item {\bf SmoothEmulator\_ModelParsInfoFile}\\
Typically, this is set to the same value as {\tt Simplex\_ModelParsInfoFile} if using Simplex. It provides the names and ranges of the model parameters. Smooth Emulator translates the scales the parameters so that they have uniform ranges, in the case of uniform distributions, or uniform widths, and zero mean for the Gaussian distributions. The default is {\tt Info/modelpar\_info.txt}

\item {\bf SmoothEmulator\_ObservableInfoFilename}\\
Smooth Emulator requires knowledge of the observables. This file lists their names and rough expectations of their range. An example of such a file is
{\tt
\begin{verbatim}
meanpt_pion  40
meanpt_proton 60
meanv2_pion 0.05
\end{verbatim}
}
The second line provides an initial estimate for the parameter $\sigma_A$. The User needn't worry if this is off by a few factors of two from the final value, but if it is off by orders of magnitude, it might take Smooth Emulator a long time to find the appropriate range. The default file name is {\tt Info/observable\_info.txt}
\item {\bf SmoothEmulator\_TrainingPts}\\
This lists which full-model training runs SmoothEmulator will use to train the emulator. This provides the User with the flexibility to use some subset for training, as may be the case when testing the accuracy. The default is ``1''. An example the User might enter could be\\
{\tt ~SmoothEmulator\_TrainingPts  0-4,13,15}\\
This would choose the training information from the directories {\tt run0,run1,run2,run3,run4,run13} and {\tt run14}, which would be found in the directory denoted by the {\tt SmoothEmulator\_ModelRunDirName} parameter.
\end{enumerate}

\subsection{Code}

The Code uses a fake model which acts as a template used to represent a potential model. It will be replaced by the actual model created by the user. The file reads in the model prior info and the observable info files from the info directory and generates the observable text files in the run directory. 

To use the fake model run the following command in the terminal window in the project directory. 

{\tt 
\begin{verbatim}
    % fakemodel 
\end{verbatim}
}
 
\subsection{Writing Coefficients}

In the terminal window run the following command after the simplex and importing the model.

{\tt 
\begin{verbatim}
    % smoothy parameters/emulator_parameters.txt 
\end{verbatim}
}

This code is responsible for invoking the primary functionality that adjusts the training points for the model. It produces samples of coefficients, which are then arranged in a directory within the project directory that provides details about each observable and various coefficient values.

This function aims to perform a Markov Chain Monte Carlo (MCMC) parameter tuning process to optimize some coefficients of a smooth emulator. The code attempts to find the best set of coefficients that maximize the log probability of the emulator given some training data. 

Final Output and Results:
After completing the specified number of iterations, the algorithm calculates the success percentage (proportion of successful updates), the final value of SigmaA, and the log-likelihood normalized by the number of degrees of freedom (Ndof) for the best parameter set (BestLogP/Ndof).  

Interpreting the Results:
The success percentage gives an indication of the acceptance rate of new parameter sets during the MCMC process. A higher success rate generally indicates efficient parameter tuning. The value of SigmaA represents the estimated uncertainty or spread in the parameter space. The BestLogP/Ndof provides a measure of the goodness of fit achieved by the best parameter set. 

The function also updates statistics for the sampled variance (SigmaA) to calculate the average variance (SigmaAbar) over all the generated samples. In summary, It iteratively tunes the coefficients using MCMC and stores the optimized coefficient samples in a matrix for further analysis. It is used for the process of generating and analyzing samples for the smooth emulator.

The Code also Logs the comparison between the predicted value and the actual training data value for the current observable. Also, log the corresponding uncertainty. The function evaluates the smooth emulator's accuracy by generating predictions for each observable at the training points and comparing these predictions with the actual training data.  

The code also writes metadata about the number of parameters (NPars), maximum rank (MaxRank), and total number of coefficients (NCoefficients) to a file named "meta.txt" in the created directory. For each sample generated using the function, it writes the corresponding coefficients (parameters) to a separate file named "sampleX.txt" in the created directory, where "X" represents the sample index. The number of coefficients is equal to NCoefficients, and they are written in a column-wise format. 

\end{document}
